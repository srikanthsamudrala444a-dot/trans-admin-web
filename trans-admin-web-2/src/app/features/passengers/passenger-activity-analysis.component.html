<div class="passenger-activity-container">
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>analytics</mat-icon>
        Trip & Activity Analysis
      </mat-card-title>
      <mat-card-subtitle *ngIf="passengerActivity">
        {{ passengerActivity.passengerName }} - Comprehensive Activity Report
      </mat-card-subtitle>
    </mat-card-header>
    
    <!-- Overview Cards -->
    <mat-card-content *ngIf="passengerActivity && !isLoading">
      <div class="overview-grid">
        <div class="stat-card">
          <div class="stat-icon trips">
            <mat-icon>directions_car</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ passengerActivity.tripAnalytics.totalTrips }}</div>
            <div class="stat-label">Total Trips</div>
            <div class="stat-detail">
              {{ passengerActivity.tripAnalytics.completionRate | number:'1.1-1' }}% completion rate
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon wallet">
            <mat-icon>account_balance_wallet</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatCurrency(passengerActivity.walletSummary.currentBalance) }}</div>
            <div class="stat-label">Wallet Balance</div>
            <div class="stat-detail">
              {{ passengerActivity.walletSummary.transactionCount }} transactions
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon rating">
            <mat-icon>star</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ passengerActivity.feedbackSummary.averageRating | number:'1.1-1' }}</div>
            <div class="stat-label">Average Rating</div>
            <div class="stat-detail">
              {{ passengerActivity.feedbackSummary.totalFeedbacks }} feedbacks
            </div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon spending">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatCurrency(passengerActivity.tripAnalytics.totalSpent) }}</div>
            <div class="stat-label">Total Spent</div>
            <div class="stat-detail">
              {{ formatCurrency(passengerActivity.tripAnalytics.averageFare) }} avg fare
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>

    <!-- Loading State -->
    <mat-card-content *ngIf="isLoading" class="loading-content">
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading passenger activity data...</p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Filters Section -->
  <mat-card class="filters-card" *ngIf="!isLoading">
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>filter_list</mat-icon>
          Filters & Export Options
        </mat-panel-title>
      </mat-expansion-panel-header>
      
      <form [formGroup]="filterForm" class="filters-form">
        <div class="filter-row">
          <!-- Date Range -->
          <div formGroupName="dateRange">
            <mat-form-field appearance="outline">
              <mat-label>Start Date</mat-label>
              <input matInput [matDatepicker]="startPicker" formControlName="startDate">
              <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>End Date</mat-label>
              <input matInput [matDatepicker]="endPicker" formControlName="endDate">
              <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <!-- Status Filter -->
          <mat-form-field appearance="outline">
            <mat-label>Trip Status</mat-label>
            <mat-select multiple formControlName="status">
              <mat-option value="completed">Completed</mat-option>
              <mat-option value="cancelled">Cancelled</mat-option>
              <mat-option value="scheduled">Scheduled</mat-option>
              <mat-option value="no-show">No Show</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Payment Method Filter -->
          <mat-form-field appearance="outline">
            <mat-label>Payment Method</mat-label>
            <mat-select multiple formControlName="paymentMethod">
              <mat-option value="cash">Cash</mat-option>
              <mat-option value="card">Card</mat-option>
              <mat-option value="wallet">Wallet</mat-option>
              <mat-option value="upi">UPI</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="filter-row">
          <!-- Vehicle Type Filter -->
          <mat-form-field appearance="outline">
            <mat-label>Vehicle Type</mat-label>
            <mat-select multiple formControlName="vehicleType">
              <mat-option value="BIKE">Bike</mat-option>
              <mat-option value="CAB">Cab</mat-option>
              <mat-option value="AUTO">Auto</mat-option>
              <mat-option value="BUS">Bus</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Rating Range -->
          <div formGroupName="ratingRange" class="range-inputs">
            <mat-form-field appearance="outline">
              <mat-label>Min Rating</mat-label>
              <input matInput type="number" min="0" max="5" step="0.1" formControlName="min">
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Max Rating</mat-label>
              <input matInput type="number" min="0" max="5" step="0.1" formControlName="max">
            </mat-form-field>
          </div>

          <!-- Amount Range -->
          <div formGroupName="amountRange" class="range-inputs">
            <mat-form-field appearance="outline">
              <mat-label>Min Amount (₹)</mat-label>
              <input matInput type="number" min="0" formControlName="min">
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Max Amount (₹)</mat-label>
              <input matInput type="number" min="0" formControlName="max">
            </mat-form-field>
          </div>
        </div>

        <div class="filter-actions">
          <button mat-raised-button color="primary" type="button" (click)="applyFilters()">
            <mat-icon>search</mat-icon>
            Apply Filters
          </button>
          <button mat-button type="button" (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Clear All
          </button>
        </div>
      </form>
    </mat-expansion-panel>
  </mat-card>

  <!-- Main Content Tabs -->
  <mat-card class="content-card" *ngIf="!isLoading">
    <mat-tab-group (selectedTabChange)="onTabChange($event.index)" class="activity-tabs">
      
      <!-- Overview Tab -->
      <mat-tab label="Overview">
        <div class="tab-content" *ngIf="passengerActivity">
          <div class="analytics-grid">
            <!-- Trip Analytics -->
            <mat-card class="analytics-card">
              <mat-card-header>
                <mat-card-title>Trip Analytics</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="analytics-stats">
                  <div class="stat-row">
                    <span class="label">Completed Trips:</span>
                    <span class="value">{{ passengerActivity.tripAnalytics.completedTrips }}</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">Cancelled Trips:</span>
                    <span class="value cancelled">{{ passengerActivity.tripAnalytics.cancelledTrips }}</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">No Shows:</span>
                    <span class="value no-show">{{ passengerActivity.tripAnalytics.noShowTrips }}</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">Favorite Vehicle:</span>
                    <span class="value">{{ passengerActivity.tripAnalytics.favoriteVehicleType }}</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">Preferred Payment:</span>
                    <span class="value">{{ passengerActivity.tripAnalytics.mostUsedPaymentMethod }}</span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Wallet Summary -->
            <mat-card class="analytics-card">
              <mat-card-header>
                <mat-card-title>Wallet Summary</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="analytics-stats">
                  <div class="stat-row">
                    <span class="label">Total Credits:</span>
                    <span class="value credit">{{ formatCurrency(passengerActivity.walletSummary.totalCredits) }}</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">Total Debits:</span>
                    <span class="value debit">{{ formatCurrency(passengerActivity.walletSummary.totalDebits) }}</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">Total Refunds:</span>
                    <span class="value refund">{{ formatCurrency(passengerActivity.walletSummary.totalRefunds) }}</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">Total Top-ups:</span>
                    <span class="value topup">{{ formatCurrency(passengerActivity.walletSummary.totalTopups) }}</span>
                  </div>
                  <div class="stat-row">
                    <span class="label">Last Transaction:</span>
                    <span class="value">{{ passengerActivity.walletSummary.lastTransactionDate | date:'short' }}</span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Feedback Summary -->
            <mat-card class="analytics-card">
              <mat-card-header>
                <mat-card-title>Driver Feedback Summary</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="rating-distribution">
                  <div class="rating-bar" *ngFor="let rating of [5,4,3,2,1]">
                    <span class="rating-label">{{ rating }}★</span>
                    <div class="rating-progress">
                      <div class="rating-fill" 
                           [style.width.%]="getRatingPercentage(rating)">
                      </div>
                    </div>
                    <span class="rating-count">{{ getRatingCount(rating) }}</span>
                  </div>
                </div>

                <div class="category-ratings">
                  <div class="category-rating" *ngFor="let category of ['punctuality', 'behavior', 'cleanliness', 'communication', 'payment']">
                    <span class="category-label">{{ category | titlecase }}:</span>
                    <span class="category-value" [style.color]="getCategoryRatingColor(getCategoryAverage(category))">
                      {{ getCategoryAverage(category) | number:'1.1-1' }}
                    </span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </mat-tab>

      <!-- Trip Log Tab -->
      <mat-tab label="Trip Log">
        <div class="tab-content">
          <div class="tab-header">
            <h3>Comprehensive Trip History</h3>
            <button mat-raised-button color="primary" (click)="exportTrips()">
              <mat-icon>download</mat-icon>
              Export CSV
            </button>
          </div>

          <div class="table-container">
            <table mat-table [dataSource]="tripLogs" class="trip-table">
              
              <ng-container matColumnDef="rideId">
                <th mat-header-cell *matHeaderCellDef>Ride ID</th>
                <td mat-cell *matCellDef="let trip">
                  <span class="ride-id">{{ trip.rideId }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let trip">
                  <mat-chip [style.background-color]="getStatusColor(trip.status)" class="status-chip">
                    {{ trip.status | titlecase }}
                  </mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="pickup">
                <th mat-header-cell *matHeaderCellDef>Pickup</th>
                <td mat-cell *matCellDef="let trip">
                  <div class="location-cell">
                    <mat-icon class="location-icon">location_on</mat-icon>
                    <span [matTooltip]="trip.pickupLocation.address">
                      {{ trip.pickupLocation.address | slice:0:30 }}...
                    </span>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="dropoff">
                <th mat-header-cell *matHeaderCellDef>Drop-off</th>
                <td mat-cell *matCellDef="let trip">
                  <div class="location-cell">
                    <mat-icon class="location-icon">flag</mat-icon>
                    <span [matTooltip]="trip.dropLocation.address">
                      {{ trip.dropLocation.address | slice:0:30 }}...
                    </span>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="scheduledTime">
                <th mat-header-cell *matHeaderCellDef>Date & Time</th>
                <td mat-cell *matCellDef="let trip">
                  <div class="datetime-cell">
                    <div class="date">{{ trip.scheduledTime | date:'MMM dd, yyyy' }}</div>
                    <div class="time">{{ trip.scheduledTime | date:'HH:mm' }}</div>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="fare">
                <th mat-header-cell *matHeaderCellDef>Fare</th>
                <td mat-cell *matCellDef="let trip">
                  <div class="fare-cell">
                    <span class="amount">{{ formatCurrency(trip.fare) }}</span>
                    <small class="distance">{{ formatDistance(trip.distance) }}</small>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="paymentMethod">
                <th mat-header-cell *matHeaderCellDef>Payment</th>
                <td mat-cell *matCellDef="let trip">
                  <div class="payment-cell">
                    <mat-chip class="payment-chip">{{ trip.paymentMethod | titlecase }}</mat-chip>
                    <mat-chip [style.background-color]="getPaymentStatusColor(trip.paymentStatus)" class="status-chip">
                      {{ trip.paymentStatus | titlecase }}
                    </mat-chip>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="driverName">
                <th mat-header-cell *matHeaderCellDef>Driver</th>
                <td mat-cell *matCellDef="let trip">
                  <div class="driver-cell">
                    <span class="driver-name">{{ trip.driverName }}</span>
                    <div class="driver-rating">
                      <span class="stars">{{ getRatingStars(trip.driverRating) }}</span>
                      <span class="rating-value">{{ trip.driverRating }}</span>
                    </div>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="rating">
                <th mat-header-cell *matHeaderCellDef>Passenger Rating</th>
                <td mat-cell *matCellDef="let trip">
                  <div class="rating-cell" *ngIf="trip.passengerRating">
                    <span class="stars">{{ getRatingStars(trip.passengerRating) }}</span>
                    <span class="rating-value">{{ trip.passengerRating }}</span>
                  </div>
                  <span class="no-rating" *ngIf="!trip.passengerRating">Not Rated</span>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="tripsColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: tripsColumns;" class="trip-row"></tr>
            </table>

            <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
          </div>
        </div>
      </mat-tab>

      <!-- Wallet History Tab -->
      <mat-tab label="Wallet History">
        <div class="tab-content">
          <div class="tab-header">
            <h3>Financial Transaction History</h3>
            <button mat-raised-button color="primary" (click)="exportWallet()">
              <mat-icon>download</mat-icon>
              Export CSV
            </button>
          </div>

          <div class="table-container">
            <table mat-table [dataSource]="walletTransactions" class="wallet-table">
              
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let transaction">
                  <mat-chip [style.background-color]="getTransactionTypeColor(transaction.type)" class="type-chip">
                    {{ transaction.type | titlecase }}
                  </mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef>Amount</th>
                <td mat-cell *matCellDef="let transaction">
                  <span class="amount" [ngClass]="transaction.type">
                    {{ transaction.type === 'debit' ? '-' : '+' }}{{ formatCurrency(transaction.amount) }}
                  </span>
                </td>
              </ng-container>

              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef>Description</th>
                <td mat-cell *matCellDef="let transaction">
                  <div class="description-cell">
                    <span class="desc-text">{{ transaction.description }}</span>
                    <small class="ref-id" *ngIf="transaction.referenceId">Ref: {{ transaction.referenceId }}</small>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="paymentMethod">
                <th mat-header-cell *matHeaderCellDef>Method</th>
                <td mat-cell *matCellDef="let transaction">
                  <mat-chip class="method-chip" *ngIf="transaction.paymentMethod">
                    {{ transaction.paymentMethod | titlecase }}
                  </mat-chip>
                  <span *ngIf="!transaction.paymentMethod">-</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let transaction">
                  <mat-chip [style.background-color]="getPaymentStatusColor(transaction.status)" class="status-chip">
                    {{ transaction.status | titlecase }}
                  </mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="balanceAfter">
                <th mat-header-cell *matHeaderCellDef>Balance After</th>
                <td mat-cell *matCellDef="let transaction">
                  <span class="balance">{{ formatCurrency(transaction.balanceAfter) }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="createdAt">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let transaction">
                  <div class="datetime-cell">
                    <div class="date">{{ transaction.createdAt | date:'MMM dd, yyyy' }}</div>
                    <div class="time">{{ transaction.createdAt | date:'HH:mm' }}</div>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="walletColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: walletColumns;" class="wallet-row"></tr>
            </table>

            <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
          </div>
        </div>
      </mat-tab>

      <!-- Driver Feedback Tab -->
      <mat-tab label="Driver Feedback">
        <div class="tab-content">
          <div class="tab-header">
            <h3>Feedback from Drivers</h3>
            <button mat-raised-button color="primary" (click)="exportFeedbacks()">
              <mat-icon>download</mat-icon>
              Export CSV
            </button>
          </div>

          <div class="table-container">
            <table mat-table [dataSource]="driverFeedbacks" class="feedback-table">
              
              <ng-container matColumnDef="driverName">
                <th mat-header-cell *matHeaderCellDef>Driver</th>
                <td mat-cell *matCellDef="let feedback">
                  <span class="driver-name">{{ feedback.driverName }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="rating">
                <th mat-header-cell *matHeaderCellDef>Rating</th>
                <td mat-cell *matCellDef="let feedback">
                  <div class="rating-cell">
                    <span class="stars">{{ getRatingStars(feedback.rating) }}</span>
                    <span class="rating-value">{{ feedback.rating }}/5</span>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="feedback">
                <th mat-header-cell *matHeaderCellDef>Comments</th>
                <td mat-cell *matCellDef="let feedback">
                  <div class="feedback-text" [matTooltip]="feedback.feedback">
                    {{ feedback.feedback | slice:0:100 }}{{ feedback.feedback.length > 100 ? '...' : '' }}
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="categories">
                <th mat-header-cell *matHeaderCellDef>Category Ratings</th>
                <td mat-cell *matCellDef="let feedback">
                  <div class="categories-cell">
                    <mat-chip-set>
                      <mat-chip *ngFor="let cat of feedback.categories" 
                               [style.background-color]="getCategoryRatingColor(cat.rating)"
                               class="category-chip">
                        {{ cat.category | titlecase }}: {{ cat.rating }}
                      </mat-chip>
                    </mat-chip-set>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="rideDate">
                <th mat-header-cell *matHeaderCellDef>Ride Date</th>
                <td mat-cell *matCellDef="let feedback">
                  <div class="datetime-cell">
                    <div class="date">{{ feedback.rideDate | date:'MMM dd, yyyy' }}</div>
                    <div class="time">{{ feedback.rideDate | date:'HH:mm' }}</div>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="feedbackColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: feedbackColumns;" class="feedback-row"></tr>
            </table>

            <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
          </div>
        </div>
      </mat-tab>

    </mat-tab-group>
  </mat-card>
</div>
