<div class="reviews-ratings-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>reviews</mat-icon>
        Reviews & Ratings Management
      </h1>
      <div class="header-controls">
        <button mat-raised-button color="primary" (click)="refreshData()" [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
        
        <button mat-raised-button color="accent" (click)="exportReviews()" [disabled]="loading || !reviewsData">
          <mat-icon>download</mat-icon>
          Export
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-card class="loading-card">
      <div class="loading-content">
        <mat-icon class="loading-spinner">hourglass_empty</mat-icon>
        <p>Loading reviews and ratings...</p>
      </div>
    </mat-card>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && reviewsData" class="content-section">
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <!-- Total Reviews -->
      <mat-card class="stat-card total-reviews">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>rate_review</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ statistics?.totalReviews | number }}</div>
            <div class="stat-label">Total Reviews</div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Average Rating -->
      <mat-card class="stat-card avg-rating">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>star</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ statistics?.averageRating }} <span class="stat-unit">/5</span></div>
            <div class="stat-label">Average Rating</div>
            <div class="star-display">
              <mat-icon 
                *ngFor="let star of getStarArray(statistics?.averageRating || 0)"
                [class]="star === 1 ? 'star-full' : star === 0.5 ? 'star-half' : 'star-empty'">
                {{ star === 1 ? 'star' : star === 0.5 ? 'star_half' : 'star_border' }}
              </mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Pending Reviews -->
      <mat-card class="stat-card pending-reviews">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon matBadge="{{ statistics?.pendingReviews }}" matBadgeColor="warn">pending</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ statistics?.pendingReviews | number }}</div>
            <div class="stat-label">Pending Reviews</div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Flagged Reviews -->
      <mat-card class="stat-card flagged-reviews">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon matBadge="{{ statistics?.flaggedReviews }}" matBadgeColor="warn">flag</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ statistics?.flaggedReviews | number }}</div>
            <div class="stat-label">Flagged Reviews</div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Rating Distribution -->
    <div class="rating-distribution-section">
      <mat-card class="distribution-card">
        <mat-card-header>
          <mat-card-title>Rating Distribution</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="rating-bars">
            <div class="rating-bar" *ngFor="let rating of [5,4,3,2,1]">
              <div class="rating-label">
                <span>{{ rating }}</span>
                <mat-icon>star</mat-icon>
              </div>
              <div class="rating-progress">
                <mat-progress-bar 
                  mode="determinate" 
                  [value]="getRatingPercentage(rating)"
                  [color]="rating >= 4 ? 'primary' : rating >= 3 ? 'accent' : 'warn'">
                </mat-progress-bar>
              </div>
              <div class="rating-count">{{ getRatingCount(rating) }}</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Tabbed Content -->
    <div class="tabbed-content">
      <mat-card class="tabs-card">
        <mat-tab-group>
          
          <!-- Reviews Management Tab -->
          <mat-tab label="Reviews Management">
            <div class="tab-content">
              
              <!-- Filters -->
              <div class="filters-section">
                <mat-card class="filters-card">
                  <mat-card-content>
                    <div class="filters-grid">
                      <mat-form-field appearance="outline">
                        <mat-label>Status</mat-label>
                        <mat-select [formControl]="statusFilter">
                          <mat-option value="all">All Status</mat-option>
                          <mat-option value="pending">Pending</mat-option>
                          <mat-option value="approved">Approved</mat-option>
                          <mat-option value="flagged">Flagged</mat-option>
                          <mat-option value="removed">Removed</mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Type</mat-label>
                        <mat-select [formControl]="typeFilter">
                          <mat-option value="all">All Types</mat-option>
                          <mat-option value="driver_review">Driver Review</mat-option>
                          <mat-option value="passenger_review">Passenger Review</mat-option>
                          <mat-option value="service_review">Service Review</mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Rating</mat-label>
                        <mat-select [formControl]="ratingFilter">
                          <mat-option value="all">All Ratings</mat-option>
                          <mat-option value="5">5 Stars</mat-option>
                          <mat-option value="4">4 Stars</mat-option>
                          <mat-option value="3">3 Stars</mat-option>
                          <mat-option value="2">2 Stars</mat-option>
                          <mat-option value="1">1 Star</mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Search</mat-label>
                        <input matInput 
                               placeholder="Search reviews..." 
                               [formControl]="searchControl">
                        <mat-icon matSuffix>search</mat-icon>
                      </mat-form-field>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>

              <!-- Reviews Table -->
              <div class="table-section">
                <mat-card class="table-card">
                  <div class="table-container">
                    <mat-table [dataSource]="reviewsDataSource" matSort #reviewsSort="matSort">
                      
                      <!-- Rating Column -->
                      <ng-container matColumnDef="rating">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Rating</mat-header-cell>
                        <mat-cell *matCellDef="let review">
                          <div class="rating-cell">
                            <div class="star-rating">
                              <mat-icon 
                                *ngFor="let star of getStarArray(review.rating)"
                                [class]="star === 1 ? 'star-full' : 'star-empty'">
                                {{ star === 1 ? 'star' : 'star_border' }}
                              </mat-icon>
                            </div>
                            <span class="rating-number">{{ review.rating }}</span>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <!-- Comment Column -->
                      <ng-container matColumnDef="comment">
                        <mat-header-cell *matHeaderCellDef>Comment</mat-header-cell>
                        <mat-cell *matCellDef="let review">
                          <div class="comment-cell">
                            <p class="comment-text">{{ review.comment }}</p>
                            <div class="comment-meta" *ngIf="review.flagReason">
                              <mat-chip color="warn">{{ review.flagReason }}</mat-chip>
                            </div>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <!-- Reviewer Column -->
                      <ng-container matColumnDef="reviewer">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Reviewer</mat-header-cell>
                        <mat-cell *matCellDef="let review">
                          <div class="reviewer-cell">
                            <div class="reviewer-name">{{ review.reviewerName }}</div>
                            <div class="reviewer-type">
                              <mat-chip [color]="review.reviewerType === 'driver' ? 'primary' : 'accent'">
                                {{ review.reviewerType }}
                              </mat-chip>
                            </div>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <!-- Target Column -->
                      <ng-container matColumnDef="target">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Target</mat-header-cell>
                        <mat-cell *matCellDef="let review">
                          <div class="target-cell">
                            <div class="target-name">{{ review.targetName }}</div>
                            <div class="target-type">{{ review.type | titlecase }}</div>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <!-- Date Column -->
                      <ng-container matColumnDef="date">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Date</mat-header-cell>
                        <mat-cell *matCellDef="let review">
                          <div class="date-cell">
                            <div class="date">{{ review.createdAt | date:'shortDate' }}</div>
                            <div class="time">{{ review.createdAt | date:'shortTime' }}</div>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <!-- Status Column -->
                      <ng-container matColumnDef="status">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Status</mat-header-cell>
                        <mat-cell *matCellDef="let review">
                          <div class="status-cell">
                            <mat-chip [color]="getStatusColor(review.status)">
                              {{ review.status | titlecase }}
                            </mat-chip>
                            <div class="priority-indicator" 
                                 [style.background-color]="getPriorityColor(review.priority)"
                                 [title]="review.priority + ' priority'">
                            </div>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <!-- Actions Column -->
                      <ng-container matColumnDef="actions">
                        <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
                        <mat-cell *matCellDef="let review">
                          <div class="actions-cell">
                            <button mat-icon-button 
                                    [matMenuTriggerFor]="reviewMenu"
                                    color="primary"
                                    matTooltip="Review Actions">
                              <mat-icon>more_vert</mat-icon>
                            </button>
                            
                            <mat-menu #reviewMenu="matMenu">
                              <button mat-menu-item 
                                      (click)="approveReview(review)"
                                      [disabled]="review.status === 'approved'">
                                <mat-icon>check_circle</mat-icon>
                                <span>Approve</span>
                              </button>
                              
                              <button mat-menu-item 
                                      (click)="flagReview(review)"
                                      [disabled]="review.status === 'flagged'">
                                <mat-icon>flag</mat-icon>
                                <span>Flag</span>
                              </button>
                              
                              <button mat-menu-item 
                                      (click)="removeReview(review)"
                                      [disabled]="review.status === 'removed'">
                                <mat-icon>delete</mat-icon>
                                <span>Remove</span>
                              </button>
                            </mat-menu>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <mat-header-row *matHeaderRowDef="reviewColumns"></mat-header-row>
                      <mat-row *matRowDef="let row; columns: reviewColumns;"></mat-row>
                    </mat-table>
                  </div>
                </mat-card>

                <!-- Reviews Pagination -->
                <div class="custom-paginator-container">
                  <mat-paginator
                    #reviewsPaginator
                    [length]="reviewsDataSource.data.length"
                    [pageSize]="10"
                    [pageSizeOptions]="[5, 10, 25, 50]"
                    [showFirstLastButtons]="true"
                    aria-label="Reviews pagination">
                  </mat-paginator>

                  <div class="page-jump-container">
                    <span class="page-jump-label">Go to page:</span>
                    <input
                      type="number"
                      class="page-jump-input"
                      [(ngModel)]="reviewsPageJumpValue"
                      [min]="1"
                      [max]="getReviewsMaxPages()"
                      (keyup.enter)="jumpToReviewsPage()"
                      placeholder="#"/>
                    <button
                      mat-icon-button
                      class="page-jump-button"
                      color="primary"
                      (click)="jumpToReviewsPage()"
                      [disabled]="!reviewsPageJumpValue || reviewsPageJumpValue < 1 || reviewsPageJumpValue > getReviewsMaxPages()"
                      matTooltip="Jump to page">
                      <mat-icon>arrow_forward</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </mat-tab>

          <!-- Driver Ratings Tab -->
          <mat-tab label="Driver Ratings">
            <div class="tab-content">
              
              <!-- Driver Ratings Table -->
              <div class="table-section">
                <mat-card class="table-card">
                  <mat-card-header>
                    <mat-card-title>Driver Rating Overview</mat-card-title>
                    <mat-card-subtitle>Monitor driver performance and rating trends</mat-card-subtitle>
                  </mat-card-header>
                  
                  <div class="table-container">
                    <mat-table [dataSource]="driversDataSource" matSort #driversSort="matSort">
                      
                      <!-- Driver Name Column -->
                      <ng-container matColumnDef="driverName">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Driver</mat-header-cell>
                        <mat-cell *matCellDef="let driver">
                          <div class="driver-name-cell">
                            <mat-icon>person</mat-icon>
                            <span>{{ driver.driverName }}</span>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <!-- Total Reviews Column -->
                      <ng-container matColumnDef="totalReviews">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Total Reviews</mat-header-cell>
                        <mat-cell *matCellDef="let driver">{{ driver.totalReviews | number }}</mat-cell>
                      </ng-container>

                      <!-- Average Rating Column -->
                      <ng-container matColumnDef="averageRating">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Average Rating</mat-header-cell>
                        <mat-cell *matCellDef="let driver">
                          <div class="rating-cell">
                            <div class="star-rating">
                              <mat-icon 
                                *ngFor="let star of getStarArray(driver.averageRating)"
                                [class]="star === 1 ? 'star-full' : 'star-empty'">
                                {{ star === 1 ? 'star' : 'star_border' }}
                              </mat-icon>
                            </div>
                            <span class="rating-number">{{ driver.averageRating }}</span>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <!-- Recent Rating Column -->
                      <ng-container matColumnDef="recentRating">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Recent Rating</mat-header-cell>
                        <mat-cell *matCellDef="let driver">{{ driver.recentRating }}</mat-cell>
                      </ng-container>

                      <!-- Trend Column -->
                      <ng-container matColumnDef="trend">
                        <mat-header-cell *matHeaderCellDef>Trend</mat-header-cell>
                        <mat-cell *matCellDef="let driver">
                          <div class="trend-cell">
                            <mat-icon [style.color]="getTrendColor(driver.ratingTrend)">
                              {{ getTrendIcon(driver.ratingTrend) }}
                            </mat-icon>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <!-- Flagged Reviews Column -->
                      <ng-container matColumnDef="flaggedReviews">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Flagged</mat-header-cell>
                        <mat-cell *matCellDef="let driver">
                          <span [class]="'flagged-count ' + (driver.flaggedReviews > 3 ? 'high' : driver.flaggedReviews > 0 ? 'medium' : 'low')">
                            {{ driver.flaggedReviews }}
                          </span>
                        </mat-cell>
                      </ng-container>

                      <!-- Status Column -->
                      <ng-container matColumnDef="status">
                        <mat-header-cell *matHeaderCellDef mat-sort-header>Status</mat-header-cell>
                        <mat-cell *matCellDef="let driver">
                          <mat-chip [color]="driver.status === 'active' ? 'primary' : driver.status === 'under_review' ? 'accent' : 'warn'">
                            {{ driver.status | titlecase }}
                          </mat-chip>
                        </mat-cell>
                      </ng-container>

                      <!-- Actions Column -->
                      <ng-container matColumnDef="actions">
                        <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
                        <mat-cell *matCellDef="let driver">
                          <div class="actions-cell">
                            <button mat-icon-button 
                                    [matMenuTriggerFor]="driverMenu"
                                    color="primary"
                                    matTooltip="Driver Actions">
                              <mat-icon>more_vert</mat-icon>
                            </button>
                            
                            <mat-menu #driverMenu="matMenu">
                              <button mat-menu-item (click)="viewDriverDetails(driver)">
                                <mat-icon>visibility</mat-icon>
                                <span>View Details</span>
                              </button>
                              
                              <button mat-menu-item 
                                      (click)="suspendDriver(driver)"
                                      [disabled]="driver.status === 'suspended'">
                                <mat-icon>block</mat-icon>
                                <span>Suspend</span>
                              </button>
                            </mat-menu>
                          </div>
                        </mat-cell>
                      </ng-container>

                      <mat-header-row *matHeaderRowDef="driverColumns"></mat-header-row>
                      <mat-row *matRowDef="let row; columns: driverColumns;"></mat-row>
                    </mat-table>

                    <!-- Drivers Pagination -->
                    <div class="custom-paginator-container">
                      <mat-paginator
                        #driversPaginator
                        [length]="driversDataSource.data.length"
                        [pageSize]="10"
                        [pageSizeOptions]="[5, 10, 25, 50]"
                        [showFirstLastButtons]="true"
                        aria-label="Drivers pagination">
                      </mat-paginator>

                      <div class="page-jump-container">
                        <span class="page-jump-label">Go to page:</span>
                        <input
                          type="number"
                          class="page-jump-input"
                          [(ngModel)]="driversPageJumpValue"
                          [min]="1"
                          [max]="getDriversMaxPages()"
                          (keyup.enter)="jumpToDriversPage()"
                          placeholder="#"/>
                        <button
                          mat-icon-button
                          class="page-jump-button"
                          color="primary"
                          (click)="jumpToDriversPage()"
                          [disabled]="!driversPageJumpValue || driversPageJumpValue < 1 || driversPageJumpValue > getDriversMaxPages()"
                          matTooltip="Jump to page">
                          <mat-icon>arrow_forward</mat-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </mat-card>
              </div>
            </div>
          </mat-tab>

        </mat-tab-group>
      </mat-card>
    </div>
  </div>

  <!-- No Data State -->
  <div *ngIf="!loading && !reviewsData" class="no-data-container">
    <mat-card class="no-data-card">
      <mat-card-content>
        <div class="no-data-content">
          <mat-icon>reviews</mat-icon>
          <h3>No Reviews Data Available</h3>
          <p>Reviews and ratings data is currently unavailable. Please try again later.</p>
          <button mat-raised-button color="primary" (click)="refreshData()">
            <mat-icon>refresh</mat-icon>
            Retry
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
